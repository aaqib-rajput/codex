<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Attendance of tafsir session</title>
    <style>
      :root {
        font-family: Arial, sans-serif;
      }
      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        background: #f3f4f6;
        padding: 1rem;
      }
      .app {
        width: min(95vw, 980px);
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      }
      .panel {
        background: #fff;
        border-radius: 12px;
        padding: 1.25rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      }
      h1 {
        margin-top: 0;
        margin-bottom: 0.75rem;
      }
      .timer {
        background: #eef2ff;
        border: 1px solid #c7d2fe;
        border-radius: 10px;
        padding: 0.85rem;
        margin-bottom: 1rem;
      }
      .timer-label {
        margin: 0;
        color: #4338ca;
        font-size: 0.9rem;
      }
      .timer-value {
        margin: 0.35rem 0 0.7rem;
        font-size: 2rem;
        font-weight: 700;
        color: #312e81;
      }
      .timer-meta {
        margin: 0;
        color: #4b5563;
        font-size: 0.9rem;
      }
      .timer-controls {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.8rem;
      }
      .timer-controls button {
        background: #e0e7ff;
      }
      .row {
        display: flex;
        gap: 0.5rem;
      }
      input {
        flex: 1;
        padding: 0.6rem;
        border: 1px solid #d1d5db;
        border-radius: 8px;
      }
      button {
        border: none;
        border-radius: 8px;
        padding: 0.6rem 0.9rem;
        cursor: pointer;
      }
      #add {
        background: #2563eb;
        color: #fff;
      }
      ul {
        list-style: none;
        padding: 0;
        margin: 1rem 0 0;
      }
      li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.55rem 0.6rem;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin-bottom: 0.5rem;
      }
      li.present span {
        color: #15803d;
        font-weight: 600;
      }
      li.absent span {
        color: #dc2626;
        text-decoration: line-through;
        text-decoration-color: #dc2626;
        text-decoration-thickness: 2px;
      }
      li.speaking span {
        color: #2563eb;
        font-weight: 700;
      }
      .actions {
        display: flex;
        gap: 0.35rem;
        flex-wrap: wrap;
      }
      .toggle {
        background: #dbeafe;
      }
      .speak {
        background: #bfdbfe;
      }
      .absent {
        background: #fecaca;
      }
      .remove {
        background: #fee2e2;
      }
      .empty {
        color: #6b7280;
        margin-top: 0.85rem;
      }
      .speaker-list {
        margin-top: 0.9rem;
        padding-left: 1.1rem;
        color: #4338ca;
      }
      .export-wrap {
        margin-top: 1rem;
      }
      .export {
        width: 100%;
        background: #059669;
        color: #fff;
      }
      .export:disabled {
        background: #9ca3af;
        cursor: not-allowed;
      }
      .export-note {
        margin: 0.55rem 0 0;
        color: #4b5563;
        font-size: 0.85rem;
      }
      .speaker-list li {
        border: none;
        margin-bottom: 0.25rem;
        padding: 0;
        display: list-item;
      }
    </style>
  </head>
  <body>
    <main class="app">
      <section class="panel" aria-label="Attendance window">
        <h1>Attendance</h1>
        <form id="taskForm" class="row">
          <input id="taskInput" placeholder="Add member name..." />
          <button id="add" type="submit">Add</button>
        </form>
        <p id="empty" class="empty">No members yet.</p>
        <ul id="taskList"></ul>
        <div class="export-wrap">
          <button id="downloadCsv" class="export" type="button" disabled>
            Download attendance CSV (Google Sheets)
          </button>
          <p class="export-note">Download before refresh to keep your session data.</p>
        </div>
      </section>

      <section class="panel" aria-label="Speaker timer window">
        <h1>Speaker Stopwatch</h1>
        <section class="timer" aria-label="Speaker timer">
          <p class="timer-label">Count up from 00:00</p>
          <p id="timerValue" class="timer-value">00:00</p>
          <p id="timerMeta" class="timer-meta">Select a speaker and start the timer.</p>
          <div class="timer-controls">
            <button id="startTimer" type="button">Start</button>
            <button id="pauseTimer" type="button">Pause</button>
            <button id="resetTimer" type="button">Reset</button>
          </div>
        </section>

        <p class="timer-label">Speaking summary</p>
        <ol id="speakerList" class="speaker-list"></ol>
      </section>
    </main>

    <script>
      const taskForm = document.getElementById('taskForm');
      const taskInput = document.getElementById('taskInput');
      const taskList = document.getElementById('taskList');
      const empty = document.getElementById('empty');
      const timerValue = document.getElementById('timerValue');
      const timerMeta = document.getElementById('timerMeta');
      const speakerList = document.getElementById('speakerList');
      const startTimer = document.getElementById('startTimer');
      const pauseTimer = document.getElementById('pauseTimer');
      const resetTimer = document.getElementById('resetTimer');
      const downloadCsv = document.getElementById('downloadCsv');

      let nextId = 1;
      const tasks = [];
      const speakerOrder = [];

      let secondsElapsed = 0;
      let timerInterval = null;
      let currentSpeakerId = null;

      function formatTime(totalSeconds) {
        const minutes = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
        const seconds = String(totalSeconds % 60).padStart(2, '0');
        return `${minutes}:${seconds}`;
      }

      function updateTimerDisplay() {
        timerValue.textContent = formatTime(secondsElapsed);

        const speaker = tasks.find((task) => task.id === currentSpeakerId);
        if (!speaker) {
          timerMeta.textContent = 'No one is speaking right now.';
          return;
        }

        timerMeta.textContent = `Current: ${speaker.text} â€¢ Spoke ${formatTime(
          speaker.speakingSeconds
        )}`;
      }

      function stopTimer() {
        if (!timerInterval) return;
        clearInterval(timerInterval);
        timerInterval = null;
      }

      function startCountdown() {
        if (timerInterval) return;

        timerInterval = setInterval(() => {
          secondsElapsed += 1;
          const currentSpeaker = tasks.find((task) => task.id === currentSpeakerId);
          if (currentSpeaker) {
            currentSpeaker.speakingSeconds += 1;
          }
          updateTimerDisplay();

          render();
        }, 1000);
      }

      function resetCountdown() {
        stopTimer();
        secondsElapsed = 0;
        tasks.forEach((task) => {
          task.speakingSeconds = 0;
        });
        speakerOrder.length = 0;
        currentSpeakerId = null;
        updateTimerDisplay();
        render();
      }

      function escapeCsvField(value) {
        const text = String(value ?? '');
        if (text.includes(',') || text.includes('"') || text.includes('\n')) {
          return `"${text.replace(/"/g, '""')}"`;
        }
        return text;
      }

      function downloadAttendanceCsv() {
        if (!tasks.length) return;

        const csvRows = [
          [
            'Member Name',
            'Attendance Status',
            'Is Speaking Now',
            'Speaking Duration (min)',
            'Speaking Duration (sec)',
          ].join(','),
        ];

        tasks.forEach((task) => {
          const attendanceStatus = task.attendance[0].toUpperCase() + task.attendance.slice(1);
          const durationSeconds = task.speakingSeconds;
          csvRows.push(
            [
              escapeCsvField(task.text),
              attendanceStatus,
              task.id === currentSpeakerId ? 'Yes' : 'No',
              (durationSeconds / 60).toFixed(2),
              durationSeconds,
            ].join(',')
          );
        });

        const csvContent = csvRows.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);

        const link = document.createElement('a');
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        link.href = url;
        link.download = `attendance-${timestamp}.csv`;
        link.click();

        URL.revokeObjectURL(url);
      }

      startTimer.addEventListener('click', startCountdown);
      pauseTimer.addEventListener('click', stopTimer);
      resetTimer.addEventListener('click', resetCountdown);
      downloadCsv.addEventListener('click', downloadAttendanceCsv);

      function render() {
        taskList.innerHTML = '';
        speakerList.innerHTML = '';

        tasks.forEach((task) => {
          const li = document.createElement('li');
          li.dataset.id = String(task.id);
          li.classList.add(task.attendance);
          if (task.id === currentSpeakerId) li.classList.add('speaking');

          const text = document.createElement('span');
          text.textContent = `${task.text} (${formatTime(task.speakingSeconds)})`;

          const actions = document.createElement('div');
          actions.className = 'actions';

          const present = document.createElement('button');
          present.className = 'toggle';
          present.type = 'button';
          present.dataset.action = 'present';
          present.textContent = 'Present';

          const speak = document.createElement('button');
          speak.className = 'speak';
          speak.type = 'button';
          speak.dataset.action = 'speak';
          speak.textContent = task.id === currentSpeakerId ? 'Stop Speak' : 'Speak';

          const absent = document.createElement('button');
          absent.className = 'absent';
          absent.type = 'button';
          absent.dataset.action = 'absent';
          absent.textContent = 'Absent';

          const remove = document.createElement('button');
          remove.className = 'remove';
          remove.type = 'button';
          remove.dataset.action = 'delete';
          remove.textContent = 'Remove';

          actions.appendChild(present);
          actions.appendChild(speak);
          actions.appendChild(absent);
          actions.appendChild(remove);
          li.appendChild(text);
          li.appendChild(actions);
          taskList.appendChild(li);
        });

        speakerOrder.forEach((speakerId) => {
          const speaker = tasks.find((task) => task.id === speakerId);
          if (!speaker || speaker.speakingSeconds === 0) return;

          const li = document.createElement('li');
          li.textContent = `${speaker.text}: ${formatTime(speaker.speakingSeconds)}`;
          speakerList.appendChild(li);
        });

        empty.style.display = tasks.length ? 'none' : 'block';
        downloadCsv.disabled = tasks.length === 0;
        updateTimerDisplay();
      }

      function addTask() {
        const value = taskInput.value.trim();
        if (!value) return;

        tasks.push({
          id: nextId++,
          text: value,
          attendance: 'pending',
          speakingSeconds: 0,
        });
        taskInput.value = '';
        taskInput.focus();
        render();
      }

      taskForm.addEventListener('submit', (event) => {
        event.preventDefault();
        addTask();
      });

      taskList.addEventListener('click', (event) => {
        const button = event.target.closest('button[data-action]');
        if (!button) return;

        const li = button.closest('li[data-id]');
        if (!li) return;

        const taskId = Number(li.dataset.id);
        const taskIndex = tasks.findIndex((task) => task.id === taskId);
        if (taskIndex === -1) return;

        if (button.dataset.action === 'present') {
          tasks[taskIndex].attendance = 'present';
        }

        if (button.dataset.action === 'absent') {
          tasks[taskIndex].attendance = 'absent';
          if (currentSpeakerId === taskId) currentSpeakerId = null;
        }

        if (button.dataset.action === 'speak') {
          if (currentSpeakerId === taskId) {
            currentSpeakerId = null;
          } else {
            currentSpeakerId = taskId;
            tasks[taskIndex].attendance = 'present';
            if (!speakerOrder.includes(taskId)) {
              speakerOrder.push(taskId);
            }
          }
        }

        if (button.dataset.action === 'delete') {
          const speakerOrderIndex = speakerOrder.findIndex((id) => id === taskId);
          if (speakerOrderIndex !== -1) speakerOrder.splice(speakerOrderIndex, 1);
          if (currentSpeakerId === taskId) currentSpeakerId = null;
          tasks.splice(taskIndex, 1);
        }

        render();
      });

      updateTimerDisplay();
      render();
    </script>
  </body>
</html>
