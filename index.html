<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Tafsir Session Manager</title>

<style>
:root{
  --primary:#4f46e5;
  --light-red:#fee2e2;
  --light-green:#dcfce7;
  --gray-300:#d1d5db;
  --gray-500:#6b7280;
  font-family:Inter,system-ui,sans-serif;
}

body{
  margin:0;
  min-height:100vh;
  background:linear-gradient(135deg,#eef2ff,#f8fafc);
  display:flex;
  justify-content:center;
  padding:2rem;
}

.app{
  width:min(1200px,95vw);
  display:grid;
  grid-template-columns:1fr 1fr;
  grid-template-rows:auto 1fr;
  gap:1.5rem;
}

.panel{
  background:white;
  border-radius:18px;
  padding:1.5rem;
  box-shadow:0 20px 40px rgba(0,0,0,0.08);
  display:flex;
  flex-direction:column;
}

h1{margin:0 0 1rem;font-size:1.2rem}
.row{display:flex;gap:.5rem;margin-bottom:.7rem}

input{
  flex:1;
  padding:.6rem;
  border-radius:8px;
  border:1px solid var(--gray-300);
}

button{
  border:none;
  border-radius:8px;
  padding:.4rem .7rem;
  cursor:pointer;
  font-size:.85rem;
}

button:hover{opacity:.9}

.primary{background:var(--primary);color:white}
.present-btn{background:#dbeafe}
.speak-btn{background:#c7d2fe}
.absent-btn{background:#fecaca}
.remove-btn{background:#f3f4f6}
.control-btn{background:#e0e7ff}
.download-btn{background:#16a34a;color:white}

.timer{text-align:center;padding:1rem;border-radius:12px;background:#f3f4ff}
.timer-value{font-size:2.5rem;font-weight:700}
#speakerTimerValue{font-size:3rem;font-weight:800;color:var(--primary)}
.timer-meta{color:var(--gray-500);font-size:.9rem;margin-bottom:.5rem}

ul{list-style:none;padding:0;margin:0}
.scroll-box{overflow-y:auto;max-height:230px}

li{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:.5rem;
  border-radius:10px;
  border:1px solid #e5e7eb;
  margin-bottom:.4rem;
}

li.present{background:var(--light-green)}
li.absent{background:var(--light-red)}
li.speaking{border:2px solid var(--primary)}
</style>
</head>

<body>

<main class="app">

<section class="panel">
<h1>Session Timer</h1>
<div class="timer">
<div class="row">
<input id="sessionMinutes" type="number" min="1" placeholder="Minutes..." />
<button id="startSession" class="primary">Start</button>
</div>
<p id="sessionTimer" class="timer-value">00:00</p>
</div>
</section>

<section class="panel">
<h1>Speaking Summary</h1>
<button id="downloadCSV" class="download-btn" style="margin-bottom:10px">
Download CSV
</button>
<div class="scroll-box">
<ul id="summaryList"></ul>
</div>
</section>

<section class="panel">
<h1>Attendance</h1>

<div class="row" style="justify-content:space-between;font-weight:600">
  <span>Total: <span id="totalCount">0</span></span>
  <span style="color:green">Present: <span id="presentCount">0</span></span>
  <span style="color:red">Absent: <span id="absentCount">0</span></span>
</div>

<div class="row">
<input id="nameInput" placeholder="Add member name..." />
<button id="addBtn" class="primary">Add</button>
</div>

<div class="scroll-box">
<ul id="attendanceList"></ul>
</div>
</section>

<section class="panel">
<h1>Speaker Timer</h1>
<div class="timer">
<p id="currentSpeaker" class="timer-meta">No one speaking</p>
<p id="speakerTimerValue">02:00</p>
<div class="row" style="justify-content:center;margin-top:.5rem">
<button id="startSpeaker" class="control-btn">Start</button>
<button id="pauseSpeaker" class="control-btn">Pause</button>
<button id="resetSpeaker" class="control-btn">Reset</button>
</div>
</div>
</section>

</main>

<script>
let members=[];
let currentSpeakerId=null;
let speakerInterval=null;
let speakerTime=120;
let sessionInterval=null;
let sessionTime=0;

const attendanceList=document.getElementById("attendanceList");
const summaryList=document.getElementById("summaryList");
const speakerTimerDisplay=document.getElementById("speakerTimerValue");
const currentSpeakerDisplay=document.getElementById("currentSpeaker");

function format(sec){
  return String(Math.floor(sec/60)).padStart(2,"0")+":"+String(sec%60).padStart(2,"0");
}

/* SESSION TIMER */
function startSessionTimer(){
  const min=Number(document.getElementById("sessionMinutes").value);
  if(!min)return;
  clearInterval(sessionInterval);
  sessionTime=min*60;
  document.getElementById("sessionTimer").textContent=format(sessionTime);
  sessionInterval=setInterval(()=>{
    sessionTime--;
    if(sessionTime<=0) clearInterval(sessionInterval);
    document.getElementById("sessionTimer").textContent=format(sessionTime);
  },1000);
}
document.getElementById("startSession").onclick=startSessionTimer;
document.getElementById("sessionMinutes").addEventListener("keypress",e=>{
  if(e.key==="Enter") startSessionTimer();
});

/* ADD MEMBER */
function addMember(){
  const name=document.getElementById("nameInput").value.trim();
  if(!name)return;
  members.push({id:Date.now(),name,attendance:"",time:0});
  document.getElementById("nameInput").value="";
  render();
}
document.getElementById("addBtn").onclick=addMember;
document.getElementById("nameInput").addEventListener("keypress",e=>{
  if(e.key==="Enter") addMember();
});

/* SPEAKER TIMER */
function startSpeakerTimer(){
  if(!currentSpeakerId)return;
  clearInterval(speakerInterval);
  speakerInterval=setInterval(()=>{
    speakerTime--;
    const speaker=members.find(m=>m.id===currentSpeakerId);
    if(speaker) speaker.time++;
    if(speakerTime<=0) clearInterval(speakerInterval);
    speakerTimerDisplay.textContent=format(speakerTime);
    render();
  },1000);
}
document.getElementById("startSpeaker").onclick=startSpeakerTimer;
document.getElementById("pauseSpeaker").onclick=()=>clearInterval(speakerInterval);
document.getElementById("resetSpeaker").onclick=()=>{
  clearInterval(speakerInterval);
  speakerTime=120;
  speakerTimerDisplay.textContent="02:00";
};

/* CSV DOWNLOAD */
document.getElementById("downloadCSV").onclick=function(){
  let csv="Name,Attendance,Speaking Time (MM:SS),Speaking Time (Seconds)\n";
  members.forEach(m=>{
    csv+=`${m.name},${m.attendance||"Not Marked"},${format(m.time)},${m.time}\n`;
  });
  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="tafsir_session_report.csv";
  a.click();
  URL.revokeObjectURL(url);
};

/* RENDER */
function render(){
  attendanceList.innerHTML="";
  summaryList.innerHTML="";
  let present=0, absent=0;

  members.forEach(m=>{
    if(m.attendance==="present") present++;
    if(m.attendance==="absent") absent++;

    const li=document.createElement("li");
    if(m.attendance) li.classList.add(m.attendance);
    if(m.id===currentSpeakerId) li.classList.add("speaking");

    const nameSpan=document.createElement("span");
    nameSpan.textContent=m.name+" ("+format(m.time)+")";

    const actions=document.createElement("div");

    const presentBtn=document.createElement("button");
    presentBtn.textContent="Present";
    presentBtn.className="present-btn";
    presentBtn.onclick=()=>{m.attendance="present";render();};

    const speak=document.createElement("button");
    speak.textContent="Speak";
    speak.className="speak-btn";
    if(m.attendance==="absent"){
      speak.disabled=true;
      speak.style.opacity="0.4";
    }
    speak.onclick=()=>{
      if(m.attendance==="absent") return;
      currentSpeakerId=m.id;
      speakerTime=120;
      speakerTimerDisplay.textContent="02:00";
      currentSpeakerDisplay.textContent="Current: "+m.name;
      startSpeakerTimer();
      render();
    };

    const absentBtn=document.createElement("button");
    absentBtn.textContent="Absent";
    absentBtn.className="absent-btn";
    absentBtn.onclick=()=>{m.attendance="absent";render();};

    const remove=document.createElement("button");
    remove.textContent="Remove";
    remove.className="remove-btn";
    remove.onclick=()=>{
      members=members.filter(x=>x.id!==m.id);
      render();
    };

    actions.append(presentBtn,speak,absentBtn,remove);
    li.append(nameSpan,actions);
    attendanceList.appendChild(li);

    if(m.time>0){
      const sum=document.createElement("li");
      sum.textContent=m.name+": "+format(m.time);
      summaryList.appendChild(sum);
    }
  });

  document.getElementById("totalCount").textContent=members.length;
  document.getElementById("presentCount").textContent=present;
  document.getElementById("absentCount").textContent=absent;
}

render();
</script>

</body>
</html>
